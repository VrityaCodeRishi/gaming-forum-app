version: 2.1

# Latest CircleCI Orbs (November 2025)
orbs:
  azure-cli: circleci/azure-cli@1.3.1

# Executors with latest images
executors:
  docker-builder:
    docker:
      - image: cimg/base:2024.11
    resource_class: medium

# Reusable commands
commands:
  install-azure-cli:
    description: "Install Azure CLI latest version"
    steps:
      - run:
          name: Install Azure CLI
          command: |
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
            az version

  login-azure:
    description: "Login to Azure using Service Principal"
    steps:
      - run:
          name: Verify Azure Credentials
          command: |
            echo "Checking Azure credentials..."
            
            if [ -z "$AZURE_CLIENT_ID" ]; then
              echo "âŒ ERROR: AZURE_CLIENT_ID is not set!"
              exit 1
            fi
            
            if [ -z "$AZURE_CLIENT_SECRET" ]; then
              echo "âŒ ERROR: AZURE_CLIENT_SECRET is not set!"
              exit 1
            fi
            
            if [ -z "$AZURE_TENANT_ID" ]; then
              echo "âŒ ERROR: AZURE_TENANT_ID is not set!"
              exit 1
            fi
            
            if [ -z "$AZURE_SUBSCRIPTION_ID" ]; then
              echo "âŒ ERROR: AZURE_SUBSCRIPTION_ID is not set!"
              exit 1
            fi
            
            echo "âœ… All Azure credentials are set"
      
      - run:
          name: Azure Login
          command: |
            az login --service-principal \
              --username ${AZURE_CLIENT_ID} \
              --password ${AZURE_CLIENT_SECRET} \
              --tenant ${AZURE_TENANT_ID}
            az account set --subscription ${AZURE_SUBSCRIPTION_ID}
            az account show

  login-acr:
    description: "Login to Azure Container Registry"
    steps:
      - run:
          name: ACR Login
          command: |
            echo ${ACR_PASSWORD} | docker login ${ACR_LOGIN_SERVER} \
              --username ${ACR_USERNAME} \
              --password-stdin

# Jobs
jobs:
  # Build and push backend image
  build-backend:
    executor: docker-builder
    steps:
      - checkout
      
      - setup_remote_docker:
          docker_layer_caching: true
          version: docker24
      
      - login-acr
      
      - run:
          name: Build backend Docker image
          command: |
            SHORT_SHA=${CIRCLE_SHA1:0:7}
            
            echo "Building backend with tag: ${SHORT_SHA}"
            
            docker build \
              --cache-from ${ACR_LOGIN_SERVER}/backend:latest \
              -t ${ACR_LOGIN_SERVER}/backend:${SHORT_SHA} \
              -t ${ACR_LOGIN_SERVER}/backend:latest \
              -f backend/Dockerfile.prod \
              backend/
      
      - run:
          name: Push backend to ACR
          command: |
            SHORT_SHA=${CIRCLE_SHA1:0:7}
            
            echo "Pushing backend images..."
            docker push ${ACR_LOGIN_SERVER}/backend:${SHORT_SHA}
            docker push ${ACR_LOGIN_SERVER}/backend:latest
      
      - run:
          name: Image info
          command: |
            SHORT_SHA=${CIRCLE_SHA1:0:7}
            echo "âœ… Backend image: ${ACR_LOGIN_SERVER}/backend:${SHORT_SHA}"

  # Deploy backend container app
  deploy-backend:
    executor: docker-builder
    steps:
      - checkout
      - install-azure-cli
      - login-azure
      
      - run:
          name: Deploy Backend Container App
          command: |
            SHORT_SHA=${CIRCLE_SHA1:0:7}
            
            echo "Deploying backend with image tag: ${SHORT_SHA}"
            echo "Checking if backend container app exists..."
            
            if az containerapp show \
              --name gaming-forum-prod-backend \
              --resource-group ${RESOURCE_GROUP_NAME} \
              --query name -o tsv &> /dev/null; then
              
              echo "âœ“ Container app exists - updating..."
              az containerapp update \
                --name gaming-forum-prod-backend \
                --resource-group ${RESOURCE_GROUP_NAME} \
                --image ${ACR_LOGIN_SERVER}/backend:${SHORT_SHA} \
                --revision-suffix ${SHORT_SHA}
            else
              echo "âœ“ Creating new backend container app..."
              az containerapp create \
                --name gaming-forum-prod-backend \
                --resource-group ${RESOURCE_GROUP_NAME} \
                --environment ${CONTAINER_APP_ENVIRONMENT_NAME} \
                --image ${ACR_LOGIN_SERVER}/backend:${SHORT_SHA} \
                --target-port 8000 \
                --ingress external \
                --registry-server ${ACR_LOGIN_SERVER} \
                --registry-username ${ACR_USERNAME} \
                --registry-password ${ACR_PASSWORD} \
                --env-vars \
                  "DATABASE_URL=${DATABASE_CONNECTION_STRING}" \
                  "PYTHONUNBUFFERED=1" \
                --cpu 1.0 \
                --memory 2Gi \
                --min-replicas 1 \
                --max-replicas 3 \
                --revision-suffix ${SHORT_SHA}
            fi
      
      - run:
          name: Verify Backend Health
          command: |
            echo "Getting backend URL..."
            BACKEND_FQDN=$(az containerapp show \
              --name gaming-forum-prod-backend \
              --resource-group ${RESOURCE_GROUP_NAME} \
              --query properties.configuration.ingress.fqdn \
              -o tsv)
            
            BACKEND_URL="https://${BACKEND_FQDN}"
            echo "Backend URL: ${BACKEND_URL}"
            
            # Wait for deployment
            echo "Waiting for backend to be ready..."
            sleep 45
            
            # Health check with retry
            MAX_RETRIES=10
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -sf "${BACKEND_URL}/health" > /dev/null; then
                echo "âœ… Backend health check passed!"
                echo "export BACKEND_URL=${BACKEND_URL}" >> $BASH_ENV
                exit 0
              fi
              
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Retry $RETRY_COUNT/$MAX_RETRIES - waiting 10s..."
              sleep 10
            done
            
            echo "âŒ Backend health check failed after ${MAX_RETRIES} retries"
            exit 1
      
      - run:
          name: Test Backend API
          command: |
            source $BASH_ENV
            echo "Testing backend API..."
            
            # Test if API returns data
            RESPONSE=$(curl -s "${BACKEND_URL}/api/games")
            
            if [ -z "$RESPONSE" ] || [ "$RESPONSE" == "[]" ]; then
              echo "âš ï¸  Backend API returned empty response (database might be empty)"
            else
              echo "âœ… Backend API is returning data!"
              echo "$RESPONSE" | jq '.[0]' || true
            fi

  # Build and push frontend image (AFTER backend is deployed)
  build-frontend:
    executor: docker-builder
    steps:
      - checkout
      - install-azure-cli
      - login-azure
      
      # Get backend URL for build
      - run:
          name: Get Backend URL for Build
          command: |
            echo "Getting backend URL..."
            
            BACKEND_FQDN=$(az containerapp show \
              --name gaming-forum-prod-backend \
              --resource-group ${RESOURCE_GROUP_NAME} \
              --query properties.configuration.ingress.fqdn \
              -o tsv)
            
            BACKEND_URL="https://${BACKEND_FQDN}"
            echo "Backend URL: ${BACKEND_URL}"
            echo "export BACKEND_URL=${BACKEND_URL}" >> $BASH_ENV
      
      - setup_remote_docker:
          docker_layer_caching: true
          version: docker24
      
      - login-acr
      
      - run:
          name: Build frontend Docker image with backend URL
          command: |
            SHORT_SHA=${CIRCLE_SHA1:0:7}
            source $BASH_ENV
            
            echo "Building frontend with:"
            echo "  Tag: ${SHORT_SHA}"
            echo "  API URL: ${BACKEND_URL}"
            
            # Build with backend URL as build argument
            docker build \
              --build-arg VITE_API_URL=${BACKEND_URL} \
              -t ${ACR_LOGIN_SERVER}/frontend:${SHORT_SHA} \
              -t ${ACR_LOGIN_SERVER}/frontend:latest \
              -f frontend/Dockerfile.prod \
              frontend/
      
      - run:
          name: Push frontend to ACR
          command: |
            SHORT_SHA=${CIRCLE_SHA1:0:7}
            
            echo "Pushing frontend images..."
            docker push ${ACR_LOGIN_SERVER}/frontend:${SHORT_SHA}
            docker push ${ACR_LOGIN_SERVER}/frontend:latest
      
      - run:
          name: Image info
          command: |
            SHORT_SHA=${CIRCLE_SHA1:0:7}
            source $BASH_ENV
            echo "âœ… Frontend built with API URL: ${BACKEND_URL}"
            echo "âœ… Frontend image: ${ACR_LOGIN_SERVER}/frontend:${SHORT_SHA}"

  # Deploy frontend container app
  deploy-frontend:
    executor: docker-builder
    steps:
      - checkout
      - install-azure-cli
      - login-azure
      
      - run:
          name: Deploy Frontend Container App
          command: |
            SHORT_SHA=${CIRCLE_SHA1:0:7}
            
            echo "Deploying frontend with image tag: ${SHORT_SHA}"
            echo "Checking if frontend container app exists..."
            
            if az containerapp show \
              --name gaming-forum-prod-frontend \
              --resource-group ${RESOURCE_GROUP_NAME} \
              --query name -o tsv &> /dev/null; then
              
              echo "âœ“ Container app exists - updating..."
              az containerapp update \
                --name gaming-forum-prod-frontend \
                --resource-group ${RESOURCE_GROUP_NAME} \
                --image ${ACR_LOGIN_SERVER}/frontend:${SHORT_SHA} \
                --revision-suffix ${SHORT_SHA}
            else
              echo "âœ“ Creating new frontend container app..."
              az containerapp create \
                --name gaming-forum-prod-frontend \
                --resource-group ${RESOURCE_GROUP_NAME} \
                --environment ${CONTAINER_APP_ENVIRONMENT_NAME} \
                --image ${ACR_LOGIN_SERVER}/frontend:${SHORT_SHA} \
                --target-port 3000 \
                --ingress external \
                --registry-server ${ACR_LOGIN_SERVER} \
                --registry-username ${ACR_USERNAME} \
                --registry-password ${ACR_PASSWORD} \
                --cpu 0.5 \
                --memory 1Gi \
                --min-replicas 1 \
                --max-replicas 3 \
                --revision-suffix ${SHORT_SHA}
            fi
      
      - run:
          name: Deployment Summary
          command: |
            SHORT_SHA=${CIRCLE_SHA1:0:7}
            
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… Deployment Complete!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            FRONTEND_FQDN=$(az containerapp show \
              --name gaming-forum-prod-frontend \
              --resource-group ${RESOURCE_GROUP_NAME} \
              --query properties.configuration.ingress.fqdn \
              -o tsv)
            
            BACKEND_FQDN=$(az containerapp show \
              --name gaming-forum-prod-backend \
              --resource-group ${RESOURCE_GROUP_NAME} \
              --query properties.configuration.ingress.fqdn \
              -o tsv)
            
            echo ""
            echo "ğŸ“¦ Deployed Images:"
            echo "   Backend:  ${ACR_LOGIN_SERVER}/backend:${SHORT_SHA}"
            echo "   Frontend: ${ACR_LOGIN_SERVER}/frontend:${SHORT_SHA}"
            echo ""
            echo "ğŸŒ Application URLs:"
            echo "   Frontend: https://${FRONTEND_FQDN}"
            echo "   Backend:  https://${BACKEND_FQDN}"
            echo ""
            echo "ğŸ“Š View logs:"
            echo "   Backend:  az containerapp logs show -n gaming-forum-prod-backend -g ${RESOURCE_GROUP_NAME}"
            echo "   Frontend: az containerapp logs show -n gaming-forum-prod-frontend -g ${RESOURCE_GROUP_NAME}"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Workflows
workflows:
  version: 2
  
  # Main deployment workflow
  build-and-deploy:
    jobs:
      # Step 1: Build backend image
      - build-backend:
          filters:
            branches:
              only:
                - main
      
      # Step 2: Deploy backend (so we get backend URL)
      - deploy-backend:
          requires:
            - build-backend
          filters:
            branches:
              only:
                - main
      
      # Step 3: Build frontend WITH backend URL
      - build-frontend:
          requires:
            - deploy-backend
          filters:
            branches:
              only:
                - main
      
      # Step 4: Deploy frontend
      - deploy-frontend:
          requires:
            - build-frontend
          filters:
            branches:
              only:
                - main
